<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chrome Tab Categorizer</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      width: 600px;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 20px;
      font-size: 20px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    button:hover {
      background: #0056b3;
      transform: translateY(-1px);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 13px;
      font-weight: 500;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #cce7ff;
      color: #004085;
      border: 1px solid #b3d9ff;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-card {
      background: #e9ecef;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
    }

    .stat-number {
      font-size: 18px;
      font-weight: bold;
      color: #007bff;
    }

    .stat-label {
      font-size: 10px;
      color: #666;
      margin-top: 3px;
    }

    .categories-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
    }

    .categories-section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #333;
    }

    .category-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .category-tag {
      background: #28a745;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .tabs-section {
      max-height: 400px;
      overflow-y: auto;
    }

    .tabs-section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #333;
    }

    .tab-item {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      border-left: 3px solid #007bff;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .tab-item:hover {
      background: #e9ecef;
    }

    .tab-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .tab-favicon {
      width: 16px;
      height: 16px;
      border-radius: 2px;
    }

    .tab-title {
      font-weight: 600;
      color: #333;
      font-size: 12px;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .tab-url {
      font-size: 10px;
      color: #666;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .tab-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tab-category {
      background: #007bff;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
    }

    .tab-domain {
      font-size: 10px;
      color: #999;
    }

    .search-box {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 13px;
    }

    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üóÇÔ∏è Chrome Tab Categorizer</h1>

    <div class="controls">
      <button id="loadTabs">Load Chrome Tabs</button>
      <button id="generateCategories" disabled>Generate Categories</button>
      <button id="assignCategories" disabled>Assign to Tabs</button>
      <button id="clearData">Clear All</button>
    </div>

    <div id="status" class="status info" style="display: none;"></div>

    <div id="stats" class="stats" style="display: none;"></div>

    <div id="categoriesSection" class="categories-section" style="display: none;">
      <h3>ü§ñ AI Generated Categories</h3>
      <div id="categoryList" class="category-list"></div>
    </div>

    <div id="tabsSection" class="tabs-section" style="display: none;">
      <h3>üìë Your Chrome Tabs</h3>
      <input type="text" id="searchBox" class="search-box" placeholder="Search tabs by title, URL, or domain..."
        style="display: none;">
      <div id="tabsContainer"></div>
    </div>
  </div>

  <script>
    // Real TabManager class that uses Chrome APIs
    class TabManager {
      constructor() {
        this.tabs = [];
        this.filteredTabs = [];
      }

      async loadAllTabs() {
        try {
          console.log('Loading tabs from Chrome...');
          const windows = await chrome.windows.getAll({ populate: true });
          this.tabs = [];

          for (const window of windows) {
            for (const tab of window.tabs) {
              const tabData = await this.enrichTabData(tab, window.id);
              this.tabs.push(tabData);
            }
          }

          this.filteredTabs = [...this.tabs];
          console.log(`Loaded ${this.tabs.length} tabs from ${windows.length} windows`);
          return this.tabs;

        } catch (error) {
          console.error('Failed to load tabs:', error);
          throw error;
        }
      }

      async enrichTabData(tab, windowId) {
        const enrichedTab = {
          id: tab.id,
          windowId: windowId,
          title: tab.title || 'Untitled',
          url: tab.url || '',
          favicon: tab.favIconUrl || this.getDefaultFavicon(),
          isActive: tab.active,
          isPinned: tab.pinned,
          description: await this.extractPageDescription(tab),
          domain: this.extractDomain(tab.url),
          category: 'uncategorized'
        };

        return enrichedTab;
      }

      async extractPageDescription(tab) {
        if (this.isSystemPage(tab.url)) {
          return 'System page';
        }

        try {
          const results = await chrome.scripting.executeScript({
            target: { tabId: tab.id },
            func: this.getPageMetadata
          });

          return results[0]?.result?.description || 'No description available';
        } catch (error) {
          console.log(`Could not extract description from tab ${tab.id}:`, error.message);
          return 'Content not accessible';
        }
      }

      getPageMetadata() {
        const selectors = [
          'meta[name="description"]',
          'meta[property="og:description"]',
          'meta[name="twitter:description"]'
        ];

        for (const selector of selectors) {
          const meta = document.querySelector(selector);
          if (meta?.content?.trim()) {
            return { description: meta.content.trim().substring(0, 150) };
          }
        }

        const paragraphs = document.querySelectorAll('p, article p, main p');
        for (const p of paragraphs) {
          const text = p.textContent?.trim();
          if (text && text.length > 50) {
            return { description: text.substring(0, 150) };
          }
        }

        return { description: 'No description available' };
      }

      extractDomain(url) {
        try {
          return new URL(url).hostname;
        } catch {
          return 'invalid-url';
        }
      }

      isSystemPage(url) {
        return url.startsWith('chrome://') ||
          url.startsWith('chrome-extension://') ||
          url.startsWith('edge://') ||
          url.startsWith('about:') ||
          url.startsWith('moz-extension://');
      }

      getDefaultFavicon() {
        return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSIjZGRkIiByeD0iMiIvPgo8L3N2Zz4K';
      }

      getTabNames() {
        return this.tabs.map(tab => tab.title);
      }

      filterTabs(searchTerm) {
        const term = searchTerm.toLowerCase().trim();

        if (!term) {
          this.filteredTabs = [...this.tabs];
        } else {
          this.filteredTabs = this.tabs.filter(tab =>
            tab.title.toLowerCase().includes(term) ||
            tab.url.toLowerCase().includes(term) ||
            tab.domain.toLowerCase().includes(term) ||
            tab.description.toLowerCase().includes(term) ||
            tab.category.toLowerCase().includes(term)
          );
        }

        return this.filteredTabs;
      }

      async activateTab(tabId) {
        try {
          const tab = await chrome.tabs.get(tabId);
          await chrome.tabs.update(tabId, { active: true });
          await chrome.windows.update(tab.windowId, { focused: true });
          window.close();
        } catch (error) {
          console.error('Failed to activate tab:', error);
          throw error;
        }
      }

      assignCategories(categories) {
        // Enhanced category assignment based on URL patterns and titles
        const categoryPatterns = {
          'Communication': [
            'mail.google.com', 'outlook', 'slack', 'discord', 'telegram',
            'whatsapp', 'messenger', 'zoom', 'teams', 'gmail'
          ],
          'Development': [
            'github', 'stackoverflow', 'codepen', 'jsfiddle', 'repl.it',
            'dev.to', 'medium.com/@', 'developer.mozilla', 'npm', 'yarn'
          ],
          'Entertainment': [
            'youtube', 'netflix', 'spotify', 'twitch', 'hulu',
            'disney', 'prime', 'music', 'podcast', 'video'
          ],
          'Social': [
            'facebook', 'twitter', 'instagram', 'linkedin', 'reddit',
            'tiktok', 'snapchat', 'pinterest', 'social'
          ],
          'Shopping': [
            'amazon', 'ebay', 'etsy', 'shop', 'store', 'buy',
            'cart', 'checkout', 'product', 'price'
          ],
          'News': [
            'news', 'cnn', 'bbc', 'reuters', 'ap', 'npr',
            'nytimes', 'guardian', 'wsj', 'techcrunch'
          ],
          'Productivity': [
            'docs.google', 'notion', 'trello', 'asana', 'monday',
            'airtable', 'calendar', 'drive', 'dropbox', 'office'
          ],
          'Education': [
            'coursera', 'udemy', 'khan', 'edx', 'pluralsight',
            'learning', 'course', 'tutorial', 'education'
          ]
        };

        this.tabs.forEach(tab => {
          const tabContent = (tab.title + ' ' + tab.url + ' ' + tab.description).toLowerCase();
          let bestMatch = null;
          let bestScore = 0;

          for (const [category, patterns] of Object.entries(categoryPatterns)) {
            if (!categories.includes(category)) continue;

            let score = 0;
            for (const pattern of patterns) {
              if (tabContent.includes(pattern.toLowerCase())) {
                score += pattern.length; // Longer matches get higher scores
              }
            }

            if (score > bestScore) {
              bestScore = score;
              bestMatch = category;
            }
          }

          tab.category = bestMatch || (categories.length > 0 ? categories[Math.floor(Math.random() * categories.length)] : 'uncategorized');
        });
      }

      getStatistics() {
        const windowCount = new Set(this.tabs.map(tab => tab.windowId)).size;
        const pinnedCount = this.tabs.filter(tab => tab.isPinned).length;
        const categorizedCount = this.tabs.filter(tab => tab.category !== 'uncategorized').length;

        return {
          totalTabs: this.tabs.length,
          windowCount,
          pinnedCount,
          categorizedCount
        };
      }
    }

    // AI Manager with built-in Prompt API fallback
    class AIManager {
      constructor() {
        this.aiSession = null;
        this.isAIAvailable = false;
      }

      async initializeAI() {
        try {
          console.log('Checking Chrome AI availability...');

          if (typeof window.ai !== 'undefined' && window.ai.languageModel) {
            this.aiSession = await window.ai.languageModel.create({
              systemPrompt: "You analyze browser tab titles and generate logical category names for organizing them. Respond only with comma-separated category names that are relevant and concise."
            });
            this.isAIAvailable = true;
            console.log('Chrome AI ready for category generation');
          } else {
            throw new Error('Chrome AI not available');
          }
        } catch (error) {
          console.log('Chrome AI not available, using fallback logic:', error.message);
          this.isAIAvailable = false;
        }
      }

      async generateCategoriesFromTabNames(tabNames) {
        if (this.isAIAvailable && this.aiSession) {
          try {
            const tabNamesString = Array.isArray(tabNames) ? tabNames.join(', ') : tabNames;
            const response = await this.aiSession.prompt(`Analyze these browser tab titles and generate 5-8 relevant category names: ${tabNamesString}`);
            const categories = response.split(',').map(cat => cat.trim()).filter(cat => cat.length > 0);
            console.log('AI Generated categories:', categories);
            return categories;
          } catch (error) {
            console.error('AI generation failed:', error);
          }
        }

        // Fallback: analyze tab names and generate categories
        console.log('Using fallback category generation');
        return this.generateFallbackCategories(tabNames);
      }

      generateFallbackCategories(tabNames) {
        const categories = new Set();
        const tabContent = tabNames.join(' ').toLowerCase();

        // Predefined category detection
        const categoryKeywords = {
          'Communication': ['gmail', 'mail', 'slack', 'discord', 'zoom', 'teams', 'chat', 'message'],
          'Development': ['github', 'stackoverflow', 'code', 'dev', 'programming', 'developer', 'docs'],
          'Entertainment': ['youtube', 'netflix', 'spotify', 'music', 'video', 'movie', 'game', 'twitch'],
          'Social Media': ['facebook', 'twitter', 'instagram', 'linkedin', 'reddit', 'social'],
          'Shopping': ['amazon', 'shop', 'store', 'buy', 'cart', 'product', 'price'],
          'News': ['news', 'cnn', 'bbc', 'article', 'breaking', 'headlines'],
          'Productivity': ['docs', 'sheets', 'calendar', 'drive', 'notion', 'trello', 'task'],
          'Search & Reference': ['google', 'search', 'wikipedia', 'reference', 'lookup']
        };

        for (const [category, keywords] of Object.entries(categoryKeywords)) {
          if (keywords.some(keyword => tabContent.includes(keyword))) {
            categories.add(category);
          }
        }

        // Add some generic categories if we don't have enough specific ones
        if (categories.size < 3) {
          categories.add('Web Tools');
          categories.add('Research');
          categories.add('Utilities');
        }

        return Array.from(categories).slice(0, 6);
      }

      destroy() {
        if (this.aiSession) {
          this.aiSession.destroy?.();
          this.aiSession = null;
          this.isAIAvailable = false;
        }
      }
    }

    // Main application
    class TabCategorizerApp {
      constructor() {
        this.tabManager = new TabManager();
        this.aiManager = new AIManager();
        this.generatedCategories = [];
        this.initializeEventListeners();
        this.checkChromeAPIs();
      }

      checkChromeAPIs() {
        if (typeof chrome === 'undefined' || !chrome.tabs) {
          this.showStatus('Chrome APIs not available. This extension needs to run in a Chrome extension context.', 'error');
          return false;
        }
        return true;
      }

      initializeEventListeners() {
        document.getElementById('loadTabs').addEventListener('click', () => this.loadTabs());
        document.getElementById('generateCategories').addEventListener('click', () => this.generateCategories());
        document.getElementById('assignCategories').addEventListener('click', () => this.assignCategories());
        document.getElementById('clearData').addEventListener('click', () => this.clearData());

        // Search functionality
        const searchBox = document.getElementById('searchBox');
        searchBox.addEventListener('input', (e) => {
          this.tabManager.filterTabs(e.target.value);
          this.renderTabs();
        });
      }

      showStatus(message, type = 'info') {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
        statusEl.style.display = 'block';

        if (type === 'success' || type === 'info') {
          setTimeout(() => {
            statusEl.style.display = 'none';
          }, 4000);
        }
      }

      updateStats() {
        const stats = this.tabManager.getStatistics();
        const statsEl = document.getElementById('stats');

        statsEl.innerHTML = `
          <div class="stat-card">
            <div class="stat-number">${stats.totalTabs}</div>
            <div class="stat-label">Total Tabs</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${stats.categorizedCount}</div>
            <div class="stat-label">Categorized</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${this.generatedCategories.length}</div>
            <div class="stat-label">Categories</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${stats.windowCount}</div>
            <div class="stat-label">Windows</div>
          </div>
        `;

        statsEl.style.display = 'grid';
      }

      async loadTabs() {
        if (!this.checkChromeAPIs()) return;

        try {
          this.showStatus('Loading Chrome tabs...', 'info');

          await this.tabManager.loadAllTabs();
          this.renderTabs();
          this.updateStats();

          document.getElementById('generateCategories').disabled = false;
          document.getElementById('searchBox').style.display = 'block';
          this.showStatus(`Successfully loaded ${this.tabManager.tabs.length} tabs`, 'success');

        } catch (error) {
          this.showStatus(`Failed to load tabs: ${error.message}`, 'error');
          console.error('Load tabs error:', error);
        }
      }

      async generateCategories() {
        try {
          this.showStatus('Initializing AI and generating categories...', 'info');

          await this.aiManager.initializeAI();
          const tabNames = this.tabManager.getTabNames();

          if (tabNames.length === 0) {
            throw new Error('No tabs loaded. Please load tabs first.');
          }

          this.generatedCategories = await this.aiManager.generateCategoriesFromTabNames(tabNames);

          if (this.generatedCategories.length === 0) {
            throw new Error('No categories generated');
          }

          this.renderCategories();
          this.updateStats();

          document.getElementById('assignCategories').disabled = false;
          this.showStatus(`Generated ${this.generatedCategories.length} categories`, 'success');

        } catch (error) {
          this.showStatus(`Failed to generate categories: ${error.message}`, 'error');
          console.error('Generate categories error:', error);
        }
      }

      assignCategories() {
        try {
          if (this.generatedCategories.length === 0) {
            throw new Error('No categories available. Please generate categories first.');
          }

          this.showStatus('Assigning categories to tabs...', 'info');

          this.tabManager.assignCategories(this.generatedCategories);
          this.renderTabs();
          this.updateStats();

          this.showStatus('Successfully categorized all tabs', 'success');

        } catch (error) {
          this.showStatus(`Failed to assign categories: ${error.message}`, 'error');
          console.error('Assign categories error:', error);
        }
      }

      clearData() {
        this.tabManager.tabs = [];
        this.tabManager.filteredTabs = [];
        this.generatedCategories = [];

        document.getElementById('tabsSection').style.display = 'none';
        document.getElementById('categoriesSection').style.display = 'none';
        document.getElementById('stats').style.display = 'none';
        document.getElementById('status').style.display = 'none';
        document.getElementById('searchBox').style.display = 'none';

        document.getElementById('generateCategories').disabled = true;
        document.getElementById('assignCategories').disabled = true;

        this.showStatus('All data cleared', 'success');
      }

      renderTabs() {
        const tabsContainer = document.getElementById('tabsContainer');
        const tabsSection = document.getElementById('tabsSection');

        if (this.tabManager.filteredTabs.length === 0) {
          if (this.tabManager.tabs.length === 0) {
            tabsSection.style.display = 'none';
          } else {
            tabsContainer.innerHTML = '<div class="loading">No tabs match your search criteria.</div>';
          }
          return;
        }

        tabsContainer.innerHTML = this.tabManager.filteredTabs.map(tab => `
          <div class="tab-item" onclick="app.activateTab(${tab.id})">
            <div class="tab-header">
              <img class="tab-favicon" src="${tab.favicon}" alt="favicon" onerror="this.style.display='none'">
              <div class="tab-title" title="${tab.title}">${tab.title}</div>
            </div>
            <div class="tab-url" title="${tab.url}">${tab.url}</div>
            <div class="tab-footer">
              <div class="tab-category">${tab.category}</div>
              <div class="tab-domain">${tab.domain}</div>
            </div>
          </div>
        `).join('');

        tabsSection.style.display = 'block';
      }

      renderCategories() {
        const categoryList = document.getElementById('categoryList');
        const categoriesSection = document.getElementById('categoriesSection');

        if (this.generatedCategories.length === 0) {
          categoriesSection.style.display = 'none';
          return;
        }

        categoryList.innerHTML = this.generatedCategories.map(category =>
          `<div class="category-tag">${category}</div>`
        ).join('');

        categoriesSection.style.display = 'block';
      }

      async activateTab(tabId) {
        try {
          await this.tabManager.activateTab(tabId);
        } catch (error) {
          this.showStatus(`Failed to activate tab: ${error.message}`, 'error');
        }
      }
    }

    // Initialize the application
    const app = new TabCategorizerApp();
  </script>
</body>

</html>